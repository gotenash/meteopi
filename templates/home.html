{% extends "base.html" %}

{% block title %}Tableau de Bord - Station M√©t√©o{% endblock %}

{% block content %}
    <!-- La page se rafra√Æchira toutes les 60 secondes -->
    <meta http-equiv="refresh" content="60">

    <style>
        /* Mise en page 2 colonnes responsive */
        .dashboard-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-start;
        }
        .dashboard-column {
            flex: 1;
            min-width: 300px; /* Passe en colonne unique sur mobile */
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        /* Styles sp√©cifiques pour les cartes compactes */
        .card h1, .card h2, .card h3 {
            margin-top: 0;
        }

        /* Style des barres de temp√©rature */
        .temp-bar-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            font-size: 0.95em;
        }
        .temp-label {
            width: 110px;
            font-weight: bold;
            color: #555;
        }
        .temp-val {
            width: 45px;
            text-align: center;
            font-weight: 500;
        }
        .bar-track {
            flex-grow: 1;
            background-color: #e0e0e0;
            height: 8px;
            border-radius: 4px;
            margin: 0 10px;
            position: relative;
            overflow: hidden;
        }
        .bar-fill {
            position: absolute;
            height: 100%;
            /* D√©grad√© du bleu (froid) vers le rouge (chaud) */
            background: linear-gradient(90deg, #3498db, #e74c3c);
            border-radius: 4px;
            opacity: 0.85;
        }
        
        /* Style r√©sum√© m√©t√©o */
        .weather-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .weather-temp {
            font-size: 3em;
            font-weight: bold;
            color: #333;
        }
        .weather-details {
            text-align: right;
            font-size: 1.1em;
            line-height: 1.4;
            color: #555;
        }
        .weather-secondary {
            display: flex;
            justify-content: space-between;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 8px;
            font-weight: 500;
        }
    </style>

    <div class="dashboard-container">
        <!-- Colonne Gauche : R√©sum√© actuel -->
        <div class="dashboard-column">
            <div class="card">
                <h1>üì° Station M√©t√©o</h1>
                
                <div class="weather-main">
                    <div class="weather-temp">{{ temp }}¬∞C</div>
                    <div class="weather-details">
                        <div>üíß {{ hum }} %</div>
                        <div>üìà {{ pressure }} hPa</div>
                    </div>
                </div>

                <div class="weather-secondary">
                    <div>üí® {{ wind }} km/h ({{ wind_dir }})</div>
                    <div>üåßÔ∏è {{ rain }} mm (24h)</div>
                </div>

                <div style="margin-top: 15px; font-size: 0.85em; color: #777; display: flex; justify-content: space-between;">
                    <span>Maj: {{ last_update }}</span>
                    {% if temp_hum_summary %}
                    <span style="font-style: italic;">{{ temp_hum_summary }}</span>
                    {% endif %}
                </div>
            </div>

            <div class="card rain-summary">
                <h3>üåßÔ∏è Activit√© Pluie (24h)</h3>
                <div style="font-size: 0.9em; line-height: 1.4;">
                    {{ rain_summary | safe }}
                </div>
            </div>
        </div>

        <!-- Colonne Droite : Pr√©visions et Stats -->
        <div class="dashboard-column">
            {% if prediction %}
            <div class="card prediction">
                <h3>üîÆ Pr√©vision Locale</h3>
                <p style="font-size: 1.1em; margin-bottom: 0;">{{ prediction }}</p>
            </div>
            {% endif %}

            <div class="card stats-container">
                <h3>üìä √âcarts de Temp√©rature</h3>
                {% if stats %}
                    {% for key in ['day', 'day_1', 'day_2', 'day_3', 'day_4', 'day_5', 'week', 'month'] %}
                        {% if stats[key] %}
                            {% set s = stats[key] %}
                            {# Calcul des pourcentages pour la barre CSS #}
                            {% set range_val = scale_max - scale_min %}
                            {% if range_val == 0 %}{% set range_val = 1 %}{% endif %}
                            {% set left_pct = ((s.min - scale_min) / range_val) * 100 %}
                            {% set width_pct = ((s.max - s.min) / range_val) * 100 %}
                            
                            {% if s.date_iso %}
                            <a href="{{ url_for('daily_graph', date=s.date_iso) }}" style="text-decoration: none; color: inherit; display: block;" title="Cliquez pour voir le graphique d√©taill√©">
                            {% endif %}
                            
                            <div class="temp-bar-row">
                                <div class="temp-label" title="Pluie : {{ '%.2f'|format(s.rain_total) }} mm">{{ s.icon }} {{ s.label }}</div>
                                <div class="temp-val">{{ s.min_str }}¬∞</div>
                                <div class="bar-track">
                                    <!-- La barre color√©e positionn√©e dynamiquement -->
                                    <div class="bar-fill" style="left: {{ left_pct }}%; width: {{ width_pct }}%; background: {{ s.gradient }};"></div>
                                </div>
                                <div class="temp-val">{{ s.max_str }}¬∞</div>
                            </div>
                            
                            {% if s.date_iso %}
                            </a>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <p>Pas de donn√©es statistiques disponibles.</p>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}